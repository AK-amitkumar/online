<?xml version="1.0" encoding="utf-8"?>
<openerp><data>

    <!-- ORIGINAL res.partner FORM VIEW EXTENSIONS -->
    <!-- Extend res.partner form to include set_bpk button and other bpk fields -->
    <record id="res_partner_set_bpk_button" model="ir.ui.view">
        <field name="name">res_partner_set_bpk_button</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="arch" type="xml">
            <xpath expr="//notebook" position="inside">
                <page string="ZMR BPK">
                    <group>
                        <group string="Force BPK Request Values (optional)">
                            <field name="BPKForcedFirstname" attrs="{'required': ['|', '|', ('BPKForcedLastname', '!=', False), ('BPKForcedBirthdate', '!=', False), ('BPKForcedZip', '!=', False)]}"/>
                            <field name="BPKForcedLastname" attrs="{'required': ['|', '|', ('BPKForcedFirstname', '!=', False), ('BPKForcedBirthdate', '!=', False), ('BPKForcedZip', '!=', False)]}"/>
                            <field name="BPKForcedBirthdate" attrs="{'required': ['|', '|', ('BPKForcedFirstname', '!=', False), ('BPKForcedLastname', '!=', False), ('BPKForcedZip', '!=', False)]}"/>
                            <field name="BPKForcedZip"/>
                        </group>
                        <group string="BPK Processing Status">
                            <field name="BPKRequestNeeded"/>
                            <field name="LastBPKRequest"/>
                            <field name="bpk_request_error_tries"/>
                            <field name="BPKRequestError"/>
                        </group>
                    </group>
                    <group string="BPK Requests">
                        <button colspan="2" name="set_bpk" type="object" string="Set BPK"/>
                        <!-- button colspan="2" name="tester" type="object" string="TESTER: check bpk request needed"/ -->
                        <field name="BPKRequestIDS" colspan="2" nolabel="1">
                            <tree string="BPK Requests"
                                  default_order="BPKRequestPartnerID,BPKRequestCompanyID"
                                  colors="red:BPKRequestDate == False and BPKErrorRequestDate;orange:BPKRequestDate &lt; BPKErrorRequestDate;green:BPKRequestDate &gt; BPKErrorRequestDate">
                                <field name="BPKRequestCompanyID"/>
                                <field name="BPKRequestDate"/>
                                <field name="BPKPrivate"/>
                                <field name="BPKErrorRequestDate"/>
                                <field name="BPKErrorCode"/>
                            </tree>
                        </field>
                    </group>
                </page>
            </xpath>
        </field>
    </record>
    <!-- ORIGINAL res.partner SEARCH VIEW EXTENSIONS -->
    <!-- Extend res.partner search view to include custom filters for 'Next BPK-Requests', 'BPK-Requests in Progress' -->
    <record id="res_partner_search_inherit_bpk" model="ir.ui.view">
        <field name="name">res_partner_search_inherit_bpk</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_res_partner_filter"/>
        <field name="arch" type="xml">
            <field name="name" position="after">
                <field name="BPKRequestNeeded"/>
                <field name="LastBPKRequest"/>
                <field name="write_date"/>
                <separator/>
                <!-- filter string="Scheduled BPK-Requests" name="next_bpk_requests" domain="[('BPKRequestNeeded','!=',False)]" context="{'order_by':'write_date desc',}"/ -->
                <filter string="Scheduled BPK-Requests" name="next_bpk_requests" domain="[('BPKRequestNeeded','!=',False)]"/>
                <separator/>
            </field>
        </field>
    </record>


    <!-- NEW VIEW SET TO FILTER PARTNERS BY BPK REQUESTS -->
    <!-- BPK REQUESTS: Create form, tree and list view for the res.partner -->
    <record model="ir.ui.view" id="res_partner_bpk_res_partner_form">
        <field name="name">res_partner_bpk_res_partner_form</field>
        <field name="model">res.partner</field>
        <field name="type">form</field>
        <field name="arch" type="xml">
            <form string="Partner">
                <header>
                    <button name="action_check_and_set_bpk_request_needed" type="object" string="Check BPK-Request-Needed"/>
                    <button name="action_set_bpk_request_needed" type="object" string="Schedule BPK-Request"/>
                    <button name="action_remove_bpk_request_needed" type="object" string="Unschedule BPK-Request"/>
                    <button name="compute_bpk_state_and_bpk_id" type="object" string="Compute BPK State"/>
                    <field name="bpk_id_state" widget="statusbar" statusbar_visible="pending,found"/>
                </header>
                <sheet>
                    <group name="Partner">
                        <h1 colspan="2">Partner</h1>
                        <group>
                            <field name="firstname"/>
                            <field name="lastname"/>
                            <field name="birthdate_web"/>
                            <field name="zip"/>
                        </group>
                        <group>
                            <field name="id" readonly="True"/>
                            <field name="create_date" readonly="True"/>
                            <field name="create_uid" readonly="True"/>
                            <field name="write_date" readonly="True"/>
                            <field name="write_uid" readonly="True"/>
                        </group>
                    </group>
                    <group string="Donation Deduction">
                        <group name="donation_deduction_overwrites">
                            <field name="donation_deduction_optout_web"/>
                            <field name="donation_deduction_disabled"/>
                            <div colspan="2" class="backend-help oe_edit_only">
                                <p colspan="2" style="color: grey; font-size: 10px">
                                    If any of the BPK fields is set only the values of from the BPK fields are used for all
                                    BPK requests and for donation transmissions to the ZMR (even if they are left empty)!
                                    You can use these fields if you do not want to change the donor salutation but need
                                    different values for the donation deduction transmission to the ZMR.
                                </p>
                            </div>
                            <field name="BPKForcedFirstname" attrs="{'required': ['|', '|', ('BPKForcedLastname', '!=', False), ('BPKForcedBirthdate', '!=', False), ('BPKForcedZip', '!=', False)]}"/>
                            <field name="BPKForcedLastname" attrs="{'required': ['|', '|', ('BPKForcedFirstname', '!=', False), ('BPKForcedBirthdate', '!=', False), ('BPKForcedZip', '!=', False)]}"/>
                            <field name="BPKForcedBirthdate" attrs="{'required': ['|', '|', ('BPKForcedFirstname', '!=', False), ('BPKForcedLastname', '!=', False), ('BPKForcedZip', '!=', False)]}"/>
                            <field name="BPKForcedZip"/>
                        </group>
                        <group name="bpk_request_info">
                            <field name="BPKRequestNeeded"/>
                            <field name="LastBPKRequest"/>
                            <field name="bpk_request_error_tries"/>
                            <field name="BPKRequestError" attrs="{'invisible': [('BPKRequestError', '=', False)]}"/>
                        </group>
                        <field name="BPKRequestIDS" colspan="2" nolabel="1">
                            <tree string="BPK Requests"
                                  default_order="BPKRequestPartnerID,BPKRequestCompanyID"
                                  colors="red:BPKRequestDate == False and BPKErrorRequestDate;orange:BPKRequestDate &lt; BPKErrorRequestDate;green:BPKRequestDate &gt; BPKErrorRequestDate">
                                <field name="BPKRequestCompanyID"/>
                                <field name="BPKRequestDate"/>
                                <field name="BPKPrivate"/>
                                <field name="BPKErrorRequestDate"/>
                                <field name="BPKErrorCode"/>
                            </tree>
                        </field>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record model="ir.ui.view" id="res_partner_bpk_res_partner_tree">
        <field name="name">res_partner_bpk_res_partner_tree</field>
        <field name="model">res.partner</field>
        <field name="type">tree</field>
        <field name="arch" type="xml">
            <tree string="Partner" default_order="BPKRequestNeeded desc, write_date desc"
                  colors="grey:not ((firstname and lastname and birthdate_web) or (BPKForcedFirstname and BPKForcedLastname and BPKForcedBirthdate));
                          blue:BPKRequestNeeded;
                          red:bpk_id_state == 'error';
                          orange:bpk_id_state == 'found_old';
                          green:bpk_id_state == 'found'">
                <field name="id"/>
                <field name="BPKRequestNeeded"/>
                <field name="firstname"/>
                <field name="lastname"/>
                <field name="birthdate_web" string="Birth."/>
                <field name="zip"/>
                <field name="donation_deduction_optout_web" string="OptOut"/>
                <field name="donation_deduction_disabled" string="Disabled"/>
                <field name="BPKForcedFirstname"/>
                <field name="BPKForcedLastname"/>
                <field name="BPKForcedBirthdate" string="BPK Birth."/>
                <field name="BPKForcedZip"/>
                <field name="write_date" readonly="True"/>
                <field name="LastBPKRequest"/>
                <field name="bpk_id_state"/>
            </tree>
        </field>
    </record>

    <record model="ir.ui.view" id="res_partner_bpk_res_partner_search">
        <field name="name">res_partner_bpk_res_partner_search</field>
        <field name="model">res.partner</field>
        <field name="type">search</field>
        <field name="arch" type="xml">
            <search string="BPK Requests">
                <field name="firstname"/>
                <field name="lastname"/>
                <field name="birthdate_web"/>
                <field name="zip"/>
                <field name="BPKRequestNeeded"/>
                <field name="LastBPKRequest"/>
                <field name="write_date"/>
                <field name="bpk_id_error_code"/>
                <field name="bpk_id_state"/>
                <!-- WARNING: 'order_by' is ignored in filters: https://github.com/odoo/odoo/issues/11610 -->
                <group string="Filter by BPK">
                    <filter string="BPK_Request_possible"
                            domain="[
                            '&amp;', '&amp;',
                            ('donation_deduction_optout_web', '=', False),
                            ('donation_deduction_disabled', '=', False),
                            '|',
                              '&amp;', '&amp;',
                              ('firstname', '!=', False),
                              ('lastname', '!=', False),
                              ('birthdate_web', '!=', False),

                              '&amp;', '&amp;',
                              ('BPKForcedFirstname', '!=', False),
                              ('BPKForcedLastname', '!=', False),
                              ('BPKForcedBirthdate', '!=', False),
                            ]"/>
                    <!-- filter string="BPK_Request_possible_not_planned"
                            domain="[
                            '&amp;', '&amp;', '&amp;',
                            ('donation_deduction_optout_web', '=', False),
                            ('donation_deduction_disabled', '=', False),
                            ('BPKRequestNeeded', '=', False),
                            '|',
                              '&amp;', '&amp;',
                              ('firstname', '!=', False),
                              ('lastname', '!=', False),
                              ('birthdate_web', '!=', False),

                              '&amp;', '&amp;',
                              ('BPKForcedFirstname', '!=', False),
                              ('BPKForcedLastname', '!=', False),
                              ('BPKForcedBirthdate', '!=', False),
                            ]"/ -->
                    <!-- filter string="BPK_Request_possible_not_planned_no_requests"
                            domain="[
                            '&amp;', '&amp;', '&amp;', '&amp;',
                            ('BPKRequestIDS', '=', [(6, False, [])]),
                            ('donation_deduction_optout_web', '=', False),
                            ('donation_deduction_disabled', '=', False),
                            ('BPKRequestNeeded', '=', False),
                            '|',
                              '&amp;', '&amp;',
                              ('firstname', '!=', False),
                              ('lastname', '!=', False),
                              ('birthdate_web', '!=', False),

                              '&amp;', '&amp;',
                              ('BPKForcedFirstname', '!=', False),
                              ('BPKForcedLastname', '!=', False),
                              ('BPKForcedBirthdate', '!=', False),
                            ]"/ -->
                    <!-- http://ludwiktrammer.github.io/odoo/domain-for-empty-many2many-in-attrs.html -->
                    <filter string="Partner_with_BPK_Requests" domain="[('BPKRequestIDS','!=',False)]"/>
                    <!-- filter string="Partner_without_BPK_Requests_False" domain="[('BPKRequestIDS','=',False)]"/>
                    <filter string="Partner_without_BPK_Requests_None" domain="[('BPKRequestIDS','=',None)]"/>
                    <filter string="Partner_without_BPK_Requests_List" domain="[('BPKRequestIDS','=',[])]"/>
                    <filter string="Partner_without_BPK_Requests_0" domain="[('BPKRequestIDS','=',0)]"/>
                    <filter string="Partner_without_BPK_Requests_lt0" domain="[('BPKRequestIDS','&lt;',0)]"/>
                    <filter string="Partner_without_BPK_Requests_lt1" domain="[('BPKRequestIDS','&lt;',1)]"/ -->
                    <filter string="Too_many_BPKErrors" domain="[('bpk_request_error_tries','&gt;=',20)]"/>

                </group>
                <group string="Filter by BPK-State">
                    <filter string="Found" domain="[('bpk_id_state','=','found')]"/>
                    <filter string="Found with old Data" domain="[('bpk_id_state','=','found_old')]"/>
                    <filter string="Error" domain="[('bpk_id_state','=','error')]"/>
                    <filter string="State not set" domain="[('bpk_id_state','=',False)]"/>
                </group>
                <group string="Filter by BPK-Error">
                    <filter string="No person matched" domain="[('bpk_id_error_code','ilike','F230')]"/>
                    <filter string="Multiple person matched"
                            domain="['|', ('bpk_id_error_code','ilike','F231'), ('bpk_id_error_code','ilike','F233')]"/>
                </group>
                <group string="Filter by BPK-Schedule">
                    <filter string="Scheduled for BPK-Request" name="next_bpk_requests" domain="[('BPKRequestNeeded','!=',False)]" context="{'order_by':'write_date desc'}"/>
                    <filter string="LastBPKRequest is set" name="last_bpk_requests" domain="[('LastBPKRequest','!=',False)]" context="{'order_by':'LastBPKRequest desc'}"/>
                </group>
                <group string="Group by BPK-Data">
                    <filter string="FirstBPK-State" context="{'group_by':'bpk_id_state'}"/>
                    <filter string="FirstBPK-ErrorCode" context="{'group_by':'bpk_id_error_code'}"/>
                    <filter string="Donation Deduction OptOut" context="{'group_by':'donation_deduction_optout_web'}"/>
                    <filter string="Donation Deduction Disabled" context="{'group_by':'donation_deduction_disabled'}"/>
                </group>
                <separator/>
            </search>
        </field>
    </record>
    <!-- Now we create actions for the new views -->
    <!-- https://www.odoo.com/de_DE/forum/hilfe-1/question/how-do-you-define-specific-not-default-views-for-each-view-mode-type-form-tree-etc-in-act-window-xml-76275 -->
    <!-- https://www.odoo.com/de_DE/forum/hilfe-1/question/multiple-create-form-views-same-model-107193 -->
    <record id="res_partner_bpk_res_partner_action" model="ir.actions.act_window" >
        <field name="name">BPK Partner</field>
        <field name="res_model">res.partner</field>
        <field name="type">ir.actions.act_window</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
        <field name="search_view_id" ref="res_partner_bpk_res_partner_search"/>
        <field name="filter" eval="True"/>
        <field name="context">{'search_default_next_bpk_requests':True}</field>
    </record>
    <record id="res_partner_bpk_res_partner_tree_viewaction" model="ir.actions.act_window.view">
        <field name="sequence" eval="10"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="res_partner_bpk_res_partner_tree"/>
        <field name="act_window_id" ref="res_partner_bpk_res_partner_action"/>
    </record>
    <record id="res_partner_bpk_res_partner_form_viewaction" model="ir.actions.act_window.view">
        <field name="sequence" eval="20"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="res_partner_bpk_res_partner_form"/>
        <field name="act_window_id" ref="res_partner_bpk_res_partner_action"/>
    </record>
    <!-- And we add the Action to a Menu with the shortcut menuitem -->
    <menuitem id="res_partner_bpk_res_partner_menu" action="res_partner_bpk_res_partner_action" parent="base.menu_config" sequence="1305"/>

</data></openerp>
